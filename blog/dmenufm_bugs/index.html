<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>Dmenufm Interesting Bugs - Hui-Jun Chen</title>
    
    <meta name="description" content="Dmenufm Interesting Bugs This is the interesting bugs that I encountered today.
This bug is the one I encounter when I try to implementing BulkListMass function after I finished implementing FM_EYE function.
The BulkListMass function is activated by selecting the variable $masselection in the ActionMenu. The functionality is good, but somehow FM_EYE seems to enter an endless loop, maximizes the usage of CPU, and eventually crash the whole system.
The reason for crashing is that I forgot to set the initial value for the $masselection variable, like masselection=&quot;placeholder&quot;.">
    <meta name="author" content="">
    
    <link href="https://huijunchen9260.github.io/an-old-hope.min.css" rel="stylesheet">
    <link href="https://huijunchen9260.github.io/style.css" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="https://huijunchen9260.github.io/apple-touch-icon.png">
    <link rel="icon" href="https://huijunchen9260.github.io/favicon.ico">
    <meta name="generator" content="Hugo 0.66.0" />
    
    <link rel="alternate" type="application/atom+xml" href="https://huijunchen9260.github.io/index.xml" title="Hui-Jun Chen">
    
    
    <script>
      function setTheme() {
        const time = new Date();

        const prev = localStorage.getItem('date');
        const date = String(time.getMonth() + 1) + '.' + String(time.getDate());

        const now = time.getTime();
        let sunrise;
        let sunset;

        function setBodyClass() {
          if (now > sunrise && now < sunset) return;
          document.body.classList.add('dark');
        }

        if (date !== prev) {
          fetch('https://api.ipgeolocation.io/astronomy?apiKey=5ed37d85103e4defa5df4c5298ed5215')
            .then(res => res.json())
            .then(data => {
              sunrise = data.sunrise.split(':').map(Number);
              sunset = data.sunset.split(':').map(Number);
            })
            .catch(() => {
              sunrise = [7, 0];
              sunset = [19, 0];
            })
            .finally(() => {
              sunrise = time.setHours(sunrise[0], sunrise[1], 0);
              sunset = time.setHours(sunset[0], sunset[1], 0);
              setBodyClass();
              localStorage.setItem('sunrise', sunrise);
              localStorage.setItem('sunset', sunset);
            });
          localStorage.setItem('date', date);
        } else {
          sunrise = Number(localStorage.getItem('sunrise'));
          sunset = Number(localStorage.getItem('sunset'));
          setBodyClass();
        }
      }
    </script>
  </head>
  <body class="single">
    <script>
      setTheme();
    </script>
    <header class="header">
      <nav class="nav">
        <p class="logo"><a href="https://huijunchen9260.github.io/">Hui-Jun Chen</a></p>
        <ul class="menu">
          <li>
            <a href="/about/">About</a>
          </li>
          <li>
            <a href="/project/">Projects</a>
          </li>
          <li>
            <a href="/research/">Research</a>
          </li>
          <li>
            <a href="/blog/">Blog</a>
          </li>
        </ul>
      </nav>
    </header>
    <main class="main">


<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">Dmenufm Interesting Bugs</h1>
    <div class="post-meta">December 27, 2019</div>
  </header>
  <div class="post-content"><h2 id="dmenufm-interesting-bugs">Dmenufm Interesting Bugs</h2>
<p>This is the interesting bugs that I encountered today.</p>
<p>This bug is the one I encounter when I try to implementing <code>BulkListMass</code> function after I finished implementing <code>FM_EYE</code> function.</p>
<p>The <code>BulkListMass</code> function is activated by selecting the variable <code>$masselection</code> in the <code>ActionMenu</code>. The functionality is good, but somehow <code>FM_EYE</code> seems to enter an endless loop, maximizes the usage of CPU, and eventually crash the whole system.</p>
<p>The reason for crashing is that I forgot to set the initial value for the <code>$masselection</code> variable, like <code>masselection=&quot;placeholder&quot;</code>. Just a simple placeholder can prevent the endless loop.</p>
<p>Ok, so why not assigning <code>$masselection</code> a variable will cause system to crash? Let&rsquo;s show and explain the relevant part of code of dmenufm so that you can get a clear view.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># The relevant part for ActionMenu:</span>

ActionMenu <span class="o">()</span> <span class="o">{</span> <span class="c1"># Usage: ActionMenu [MSG] [BG_COLOR]</span>
    <span class="k">while</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$actCHOICE</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
	...
	<span class="k">if</span> ...
	<span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$allowbulk</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;NotAllowed&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
	    <span class="nv">actCHOICE</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span> <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&#34;</span><span class="nv">$BACKWARD</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$TARGET</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$allowbulk</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$allselection</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$masselection</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$FM_HIS</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$list</span><span class="s2">&#34;</span> <span class="p">|</span> sed <span class="s2">&#34;/^</span>$<span class="s2">/ d&#34;</span> <span class="p">|</span> yprompt <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span><span class="k">)</span>
	...
	<span class="k">fi</span>
	<span class="c1"># Outcome matching</span>
	<span class="k">if</span> ...
	<span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$actCHOICE</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$allselection</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$actCHOICE</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$masselection</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
	    <span class="nv">bulkselection</span><span class="o">=</span><span class="s2">&#34;false&#34;</span>
	    <span class="nv">HERE</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span> <span class="s1">&#39;%s&#39;</span> <span class="s2">&#34;</span><span class="nv">$PWD</span><span class="s2">&#34;</span><span class="k">)</span>
	    <span class="nv">name</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span> <span class="s1">&#39;%s&#39;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PWD</span><span class="p">##*/</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span>
	    <span class="nb">break</span>
	...
	<span class="k">elif</span> <span class="o">[</span> -f <span class="s2">&#34;</span><span class="nv">$actCHOICE</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
	    <span class="k">if</span> ...
	    <span class="k">else</span>
		<span class="nv">rollmenu</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$actCHOICE</span><span class="s2">&#34;</span>
		<span class="nv">HERE</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span> <span class="s1">&#39;%s&#39;</span> <span class="s2">&#34;</span><span class="nv">$PWD</span><span class="s2">/</span><span class="nv">$actCHOICE</span><span class="s2">&#34;</span><span class="k">)</span>
		<span class="nv">name</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span> <span class="s1">&#39;%s&#39;</span> <span class="s2">&#34;</span><span class="nv">$actCHOICE</span><span class="s2">&#34;</span><span class="k">)</span>
		<span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$bulkselection</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;true&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">bulklist</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span> <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&#34;</span><span class="nv">$bulklist</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$HERE</span><span class="s2">&#34;</span><span class="k">)</span>
		<span class="nb">break</span>
	    <span class="k">fi</span>
	<span class="k">fi</span>
    <span class="k">done</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># Relevant part for FM_EYE</span>

FM_EYE <span class="o">()</span> <span class="o">{</span>
    ...
    ActionMenu <span class="s2">&#34;Preview mode: &#34;</span> <span class="s2">&#34;</span><span class="nv">$FM_ACTION_COLOR_LV1</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="k">return</span> <span class="o">&amp;&amp;</span> <span class="nv">allowbulk</span><span class="o">=</span><span class="s2">&#34;NotAllowed&#34;</span>
    <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$HERE</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> FileOpen <span class="s2">&#34;</span><span class="nv">$HERE</span><span class="s2">&#34;</span> <span class="p">&amp;</span>
    <span class="k">while</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$HERE</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
	wmctrl -r :ACTIVE: -N <span class="s2">&#34;PREVIEW&#34;</span> <span class="p">&amp;</span>
	ActionMenu <span class="s2">&#34;Preview mode: &#34;</span> <span class="s2">&#34;</span><span class="nv">$FM_ACTION_COLOR_LV1</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="k">return</span> <span class="o">&amp;&amp;</span> <span class="nv">allowbulk</span><span class="o">=</span><span class="s2">&#34;NotAllowed&#34;</span>
	<span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$HERE</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> FileOpen <span class="s2">&#34;</span><span class="nv">$HERE</span><span class="s2">&#34;</span> <span class="p">&amp;</span>
	wmctrl -c <span class="s2">&#34;PREVIEW&#34;</span>
    <span class="k">done</span>
    wmctrl -c :ACTIVE:
    ...
<span class="o">}</span>
</code></pre></div><p><code>...</code> is the symbol representing irrelevant code.</p>
<p>The explanation is the following:</p>
<p>Since I didn&rsquo;t assign the value for <code>$masselection</code>, <code>$masselection</code> is an empty string.</p>
<p>In the <code>FM_EYE</code> function, the first usage of <code>ActionMenu</code> will generate a string for variable <code>$HERE</code>, which according to <code>ActionMenu</code> function, is the absolute path of the chosen file (<code>HERE=$(printf '%s' &quot;$PWD/$actCHOICE&quot;)</code>). We also open the file by <code>FileOpen</code>.</p>
<p>Next, we enter the <code>while</code> loop. Since <code>$HERE</code> is not empty string, <code>[ -n &quot;$HERE&quot; ]</code> is success. After that, I use <code>wmctrl</code> to rename the active window as &ldquo;PREVIEW&rdquo;.</p>
<p>Furthermore, another usage of <code>ActionMenu</code> assigned a new absolute path based on chosen file to <code>$HERE</code>, and then open it in the background (the <code>&amp;</code> part). Notice that now the active window is the file opened by the second usage of <code>ActionMenu</code>, and we know that previous window is named &ldquo;PREVIEW&rdquo;.</p>
<p>After that, use <code>wmctrl</code> to close the window named &ldquo;PREVIEW&rdquo;, i.e., the window opened by first <code>ActionMenu</code>.</p>
<p>After existing the loop, use <code>wmctrl</code> to close active window, which would be the window opened by the second <code>ActionMenu</code>.</p>
<p>Why the failing to assign a value for <code>$masselection</code> will cause system to crash? It is all start when leaving the <code>ActionMenu</code>.</p>
<p>When you press <code>ESC</code> to escape <code>ActionMenu</code>, the <code>$actCHOICE</code> is &ldquo;assigned&rdquo; as an empty string. Since <code>$masselection</code> is also empty string, the test <code>[ &quot;$actCHOICE&quot; = &quot;$masselection&quot; ]</code> success! Thus, now <code>$HERE</code> is assigned as current working directory (<code>HERE=$(printf '%s' &quot;$PWD&quot;)</code>). Thus, the <code>while</code> loop in <code>FM_EYE</code> will execute again, and then we enter an endless loop.</p>
</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://huijunchen9260.github.io/tags/dmenu">Dmenu</a></li>
      <li><a href="https://huijunchen9260.github.io/tags/dmenufm">Dmenufm</a></li>
    </ul>
  </footer>
  
</article></main>
<footer class="footer">
  <span>&copy; 2020 <a href="https://huijunchen9260.github.io/">Hui-Jun Chen</a></span>
  <span>&middot;</span>
  <span>OSU <a href="https://economics.osu.edu/" rel="noopener" target="_blank">ECON</a>️</span>
  <span>&middot;</span>
  <span><a href="https://github.com/huijunchen9260" rel="noopener" target="_blank">GitHub</a>️</span>
  <br/>
  <span>Email: chen.9260@osu.edu</span>
</footer>
<script src="https://huijunchen9260.github.io/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
</body>
</html>

